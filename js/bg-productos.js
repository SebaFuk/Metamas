(function () {
  var canvas = document.getElementById('metamas-bg');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var W=0,H=0,scrollY=0,raf;
  var CIRCUITS=[],PARTICLES=[],SPARKS=[];
  var lastSpark=0;
  var C={bg:'#071c26',grid:'rgba(15,115,145,0.07)',gridAcc:'rgba(15,115,145,0.18)',gear:'rgba(15,115,145,0.10)',gearStroke:'rgba(15,115,145,0.22)',spark:['#ff9900','#ffcc44','#ff6600','#ffffff','#ffee88']};
  var GEARS=[{x:0.08,y:0.15,r:90,teeth:14,speed:0.003,angle:0},{x:0.92,y:0.10,r:60,teeth:10,speed:-0.005,angle:1.1},{x:0.85,y:0.55,r:110,teeth:18,speed:0.002,angle:0.5},{x:0.04,y:0.72,r:70,teeth:11,speed:-0.004,angle:2},{x:0.50,y:0.95,r:80,teeth:13,speed:0.003,angle:0.8},{x:0.95,y:0.88,r:50,teeth:8,speed:-0.006,angle:1.5}];
  var PIECES=[{cx:0.13,cy:0.22,spd:0.006,ph:0,label:'Rolo'},{cx:0.87,cy:0.18,spd:-0.005,ph:1.2,label:'Sinfín'},{cx:0.07,cy:0.55,spd:0.007,ph:0.7,label:'CNC'},{cx:0.93,cy:0.60,spd:-0.004,ph:2.1,label:'Tubo'},{cx:0.50,cy:0.85,spd:0.003,ph:0.4,label:'Base'},{cx:0.22,cy:0.78,spd:0.005,ph:1.8,label:'Eje'},{cx:0.78,cy:0.80,spd:-0.004,ph:3.0,label:'Chasis'}];

  function initCircuits(){CIRCUITS=[];var count=Math.floor(W/140);for(var i=0;i<count;i++){var segs=[],cx=Math.random()*W,cy=Math.random()*H*2,dirs=[[1,0],[-1,0],[0,1],[0,-1]],dir=dirs[Math.floor(Math.random()*4)];for(var s=0;s<6+Math.random()*6;s++){var len=40+Math.random()*120;segs.push({x:cx,y:cy});cx+=dir[0]*len;cy+=dir[1]*len;var perp=[[-dir[1],dir[0]],[dir[1],-dir[0]]];dir=perp[Math.floor(Math.random()*2)];}CIRCUITS.push({segs:segs,speed:0.2+Math.random()*0.4,pulse:Math.random()*Math.PI*2});}}
  function initParticles(){PARTICLES=[];var count=Math.min(80,Math.floor(W*H/14000));for(var i=0;i<count;i++)PARTICLES.push({x:Math.random()*W,y:Math.random()*H,r:0.6+Math.random()*1.8,vx:(Math.random()-0.5)*0.25,vy:-0.1-Math.random()*0.2,alpha:0.15+Math.random()*0.35,twinkle:Math.random()*Math.PI*2,tSpeed:0.01+Math.random()*0.02});}
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;initCircuits();initParticles();}
  window.addEventListener('resize',resize);
  window.addEventListener('scroll',function(){scrollY=window.scrollY;},{passive:true});
  resize();

  function drawGrid(){var o=-scrollY*0.08,s=48;ctx.strokeStyle=C.grid;ctx.lineWidth=0.5;for(var x=0;x<W;x+=s){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}for(var y=o%s;y<H;y+=s){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}ctx.strokeStyle=C.gridAcc;ctx.lineWidth=0.8;for(var x2=0;x2<W;x2+=s*5){ctx.beginPath();ctx.moveTo(x2,0);ctx.lineTo(x2,H);ctx.stroke();}for(var y2=o%(s*5);y2<H;y2+=s*5){ctx.beginPath();ctx.moveTo(0,y2);ctx.lineTo(W,y2);ctx.stroke();}}
  function drawGear(g,t){var x=g.x*W,y=g.y*H-scrollY*0.15,angle=g.angle+t*g.speed,r=g.r,teeth=g.teeth,toothH=r*0.22,toothW=(Math.PI*2/teeth)*0.38;ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.beginPath();for(var i=0;i<teeth;i++){var a0=(i/teeth)*Math.PI*2,a1=a0+toothW,a2=a0+(Math.PI*2/teeth)-toothW,a3=a0+Math.PI*2/teeth;ctx.lineTo(Math.cos(a0)*r,Math.sin(a0)*r);ctx.lineTo(Math.cos(a1)*(r+toothH),Math.sin(a1)*(r+toothH));ctx.lineTo(Math.cos(a2)*(r+toothH),Math.sin(a2)*(r+toothH));ctx.lineTo(Math.cos(a3)*r,Math.sin(a3)*r);}ctx.closePath();ctx.fillStyle=C.gear;ctx.strokeStyle=C.gearStroke;ctx.lineWidth=1.5;ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(0,0,r*0.28,0,Math.PI*2);ctx.fillStyle=C.bg;ctx.fill();ctx.strokeStyle=C.gearStroke;ctx.stroke();for(var i2=0;i2<6;i2++){var a=(i2/6)*Math.PI*2;ctx.beginPath();ctx.moveTo(Math.cos(a)*r*0.30,Math.sin(a)*r*0.30);ctx.lineTo(Math.cos(a)*r*0.75,Math.sin(a)*r*0.75);ctx.strokeStyle=C.gearStroke;ctx.lineWidth=1;ctx.stroke();}ctx.restore();}
  function drawCircuits(t){for(var ci=0;ci<CIRCUITS.length;ci++){var c=CIRCUITS[ci],alpha=0.06+0.06*Math.sin(t*c.speed+c.pulse),off=-scrollY*0.12;ctx.save();ctx.translate(0,off);ctx.strokeStyle='rgba(0,200,255,'+alpha+')';ctx.lineWidth=1;ctx.beginPath();for(var si=0;si<c.segs.length;si++){if(si===0)ctx.moveTo(c.segs[si].x,c.segs[si].y);else ctx.lineTo(c.segs[si].x,c.segs[si].y);}ctx.stroke();for(var si2=0;si2<c.segs.length;si2++){ctx.beginPath();ctx.arc(c.segs[si2].x,c.segs[si2].y,2.5,0,Math.PI*2);ctx.fillStyle='rgba(0,200,255,'+(alpha*2)+')';ctx.fill();}ctx.restore();}}

  function drawPiece(p,t){var px=p.cx*W,py=p.cy*H-scrollY*0.16,angle=p.ph+t*p.spd,pulse=0.35+0.20*Math.sin(t*0.6+p.ph);var grad=ctx.createRadialGradient(px,py,0,px,py,50);grad.addColorStop(0,'rgba(0,200,255,'+(0.07*pulse)+')');grad.addColorStop(1,'rgba(0,200,255,0)');ctx.beginPath();ctx.arc(px,py,50,0,Math.PI*2);ctx.fillStyle=grad;ctx.fill();ctx.save();ctx.translate(px,py);ctx.rotate(angle);ctx.globalAlpha=pulse;ctx.beginPath();for(var i=0;i<6;i++){var a=(i/6)*Math.PI*2;if(i===0)ctx.moveTo(Math.cos(a)*22,Math.sin(a)*22);else ctx.lineTo(Math.cos(a)*22,Math.sin(a)*22);}ctx.closePath();ctx.fillStyle='rgba(15,115,145,0.14)';ctx.strokeStyle='rgba(160,200,220,0.50)';ctx.lineWidth=1.2;ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fillStyle=C.bg;ctx.fill();ctx.strokeStyle='rgba(160,200,220,0.40)';ctx.stroke();for(var i2=0;i2<3;i2++){var a2=(i2/3)*Math.PI*2;ctx.beginPath();ctx.moveTo(Math.cos(a2)*9,Math.sin(a2)*9);ctx.lineTo(Math.cos(a2)*20,Math.sin(a2)*20);ctx.strokeStyle='rgba(160,200,220,0.30)';ctx.lineWidth=1;ctx.stroke();}ctx.globalAlpha=pulse*0.7;ctx.font='9px Poppins,sans-serif';ctx.fillStyle='rgba(0,200,255,1)';ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(p.label,0,26);ctx.restore();}

  function drawDimensions(t){var off=-scrollY*0.09;var dd=[{x:0.35,y:0.28,w:110,label:'∅ 48.5 mm'},{x:0.62,y:0.62,w:85,label:'L: 320 mm'},{x:0.25,y:0.58,w:95,label:'Ra 1.6 µm'},{x:0.72,y:0.36,w:75,label:'±0.01 mm'}];for(var i=0;i<dd.length;i++){var d=dd[i],cx=d.x*W,cy=d.y*H+off,alpha=0.30+0.15*Math.sin(t*0.4+i*1.1);ctx.save();ctx.globalAlpha=alpha;ctx.beginPath();ctx.moveTo(cx-d.w/2,cy);ctx.lineTo(cx+d.w/2,cy);ctx.strokeStyle='rgba(200,160,40,1)';ctx.lineWidth=0.9;ctx.stroke();for(var di=0;di<2;di++){var dir=di===0?-1:1;ctx.beginPath();ctx.moveTo(cx+dir*d.w/2,cy);ctx.lineTo(cx+dir*(d.w/2-8),cy-3);ctx.lineTo(cx+dir*(d.w/2-8),cy+3);ctx.closePath();ctx.fillStyle='rgba(200,160,40,1)';ctx.fill();}for(var ti=0;ti<2;ti++){var ox=ti===0?-d.w/2:d.w/2;ctx.beginPath();ctx.moveTo(cx+ox,cy-11);ctx.lineTo(cx+ox,cy+11);ctx.strokeStyle='rgba(200,160,40,0.6)';ctx.lineWidth=0.7;ctx.stroke();}ctx.font='10px monospace';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillStyle='rgba(200,160,40,1)';ctx.fillText(d.label,cx,cy-5);ctx.restore();}}

  function drawReticles(t){var off=-scrollY*0.18;var rr=[{x:0.18,y:0.42},{x:0.78,y:0.30},{x:0.62,y:0.82}];for(var i=0;i<rr.length;i++){var re=rr[i],rx=re.x*W,ry=re.y*H+off,pulse=0.3+0.2*Math.sin(t*0.8+re.x*10),size=18;ctx.save();ctx.globalAlpha=pulse;ctx.strokeStyle='rgba(15,200,230,0.6)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(rx-size,ry);ctx.lineTo(rx+size,ry);ctx.moveTo(rx,ry-size);ctx.lineTo(rx,ry+size);ctx.stroke();ctx.beginPath();ctx.arc(rx,ry,size*0.7,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.rect(rx-4,ry-4,8,8);ctx.stroke();ctx.restore();}}
  function drawParticles(){var off=-scrollY*0.05;for(var i=0;i<PARTICLES.length;i++){var p=PARTICLES[i];p.x+=p.vx;p.y+=p.vy;p.twinkle+=p.tSpeed;if(p.y<-10){p.y=H+10;p.x=Math.random()*W;}if(p.x<-5)p.x=W+5;if(p.x>W+5)p.x=-5;var alpha=p.alpha*(0.6+0.4*Math.sin(p.twinkle));ctx.beginPath();ctx.arc(p.x,p.y+off,p.r,0,Math.PI*2);ctx.fillStyle='rgba(15,180,210,'+alpha+')';ctx.fill();}}
  function spawnSpark(){var oo=[{x:W*0.25,y:H*0.35},{x:W*0.72,y:H*0.22},{x:W*0.55,y:H*0.68},{x:W*0.10,y:H*0.60},{x:W*0.88,y:H*0.75}];var o=oo[Math.floor(Math.random()*oo.length)];for(var i=0;i<3+Math.floor(Math.random()*5);i++){var angle=Math.random()*Math.PI*2,speed=1.5+Math.random()*3.5;SPARKS.push({x:o.x,y:o.y-scrollY*0.2,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-2,life:1,decay:0.025+Math.random()*0.04,r:1+Math.random()*2,color:C.spark[Math.floor(Math.random()*C.spark.length)],gravity:0.12,trail:[]});}}
  function drawSparks(){for(var i=SPARKS.length-1;i>=0;i--){var s=SPARKS[i];s.trail.push({x:s.x,y:s.y});if(s.trail.length>6)s.trail.shift();s.vx*=0.97;s.vy+=s.gravity;s.x+=s.vx;s.y+=s.vy;s.life-=s.decay;if(s.life<=0){SPARKS.splice(i,1);continue;}for(var j=1;j<s.trail.length;j++){ctx.beginPath();ctx.moveTo(s.trail[j-1].x,s.trail[j-1].y);ctx.lineTo(s.trail[j].x,s.trail[j].y);ctx.strokeStyle=s.color;ctx.globalAlpha=(j/s.trail.length)*s.life*0.5;ctx.lineWidth=0.8;ctx.stroke();}ctx.globalAlpha=s.life;ctx.beginPath();ctx.arc(s.x,s.y,s.r*s.life,0,Math.PI*2);ctx.fillStyle=s.color;ctx.fill();ctx.beginPath();ctx.arc(s.x,s.y,s.r*3*s.life,0,Math.PI*2);ctx.fillStyle=s.color;ctx.globalAlpha=s.life*0.15;ctx.fill();ctx.globalAlpha=1;}}

  function loop(ts){var t=ts/1000;ctx.clearRect(0,0,W,H);ctx.fillStyle=C.bg;ctx.fillRect(0,0,W,H);drawGrid();drawCircuits(t);for(var gi=0;gi<GEARS.length;gi++)drawGear(GEARS[gi],t);for(var pi=0;pi<PIECES.length;pi++)drawPiece(PIECES[pi],t);drawDimensions(t);drawReticles(t);drawParticles();if(ts-lastSpark>350){spawnSpark();lastSpark=ts;}drawSparks();raf=requestAnimationFrame(loop);}
  raf=requestAnimationFrame(loop);
})();
