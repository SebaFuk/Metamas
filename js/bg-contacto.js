(function () {
  var canvas = document.getElementById('metamas-bg');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var W=0,H=0,scrollY=0,raf,radarAngle=0;
  var CIRCUITS=[],PARTICLES=[],SPARKS=[],NODES=[],BLIPS=[],WAVES=[],MSGS=[];
  var lastSpark=0,waveTimer=0,msgTimer=0;
  var C={bg:'#071c26',grid:'rgba(15,115,145,0.07)',gridAcc:'rgba(15,115,145,0.18)',gear:'rgba(15,115,145,0.10)',gearStroke:'rgba(15,115,145,0.22)',spark:['#ff9900','#ffcc44','#ff6600','#ffffff','#ffee88']};
  var GEARS=[{x:0.08,y:0.15,r:90,teeth:14,speed:0.003,angle:0},{x:0.92,y:0.10,r:60,teeth:10,speed:-0.005,angle:1.1},{x:0.85,y:0.55,r:110,teeth:18,speed:0.002,angle:0.5},{x:0.04,y:0.72,r:70,teeth:11,speed:-0.004,angle:2},{x:0.50,y:0.95,r:80,teeth:13,speed:0.003,angle:0.8},{x:0.95,y:0.88,r:50,teeth:8,speed:-0.006,angle:1.5}];

  function initCircuits(){CIRCUITS=[];var count=Math.floor(W/140);for(var i=0;i<count;i++){var segs=[],cx=Math.random()*W,cy=Math.random()*H*2,dirs=[[1,0],[-1,0],[0,1],[0,-1]],dir=dirs[Math.floor(Math.random()*4)];for(var s=0;s<6+Math.random()*6;s++){var len=40+Math.random()*120;segs.push({x:cx,y:cy});cx+=dir[0]*len;cy+=dir[1]*len;var perp=[[-dir[1],dir[0]],[dir[1],-dir[0]]];dir=perp[Math.floor(Math.random()*2)];}CIRCUITS.push({segs:segs,speed:0.2+Math.random()*0.4,pulse:Math.random()*Math.PI*2});}}
  function initParticles(){PARTICLES=[];var count=Math.min(80,Math.floor(W*H/14000));for(var i=0;i<count;i++)PARTICLES.push({x:Math.random()*W,y:Math.random()*H,r:0.6+Math.random()*1.8,vx:(Math.random()-0.5)*0.25,vy:-0.1-Math.random()*0.2,alpha:0.15+Math.random()*0.35,twinkle:Math.random()*Math.PI*2,tSpeed:0.01+Math.random()*0.02});}
  function initNodes(){NODES=[];var n=Math.min(20,Math.floor(W/80));for(var i=0;i<n;i++)NODES.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.28,vy:(Math.random()-0.5)*0.28,r:2.5+Math.random()*2,tw:Math.random()*Math.PI*2,ts:0.01+Math.random()*0.02});}
  function initBlips(){BLIPS=[];for(var i=0;i<10;i++)BLIPS.push({angle:Math.random()*Math.PI*2,dist:0.15+Math.random()*0.75,life:0,decay:0.003+Math.random()*0.005});}
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;initCircuits();initParticles();initNodes();initBlips();}
  window.addEventListener('resize',resize);
  window.addEventListener('scroll',function(){scrollY=window.scrollY;},{passive:true});
  resize();

  function drawGrid(){var o=-scrollY*0.08,s=48;ctx.strokeStyle=C.grid;ctx.lineWidth=0.5;for(var x=0;x<W;x+=s){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}for(var y=o%s;y<H;y+=s){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}ctx.strokeStyle=C.gridAcc;ctx.lineWidth=0.8;for(var x2=0;x2<W;x2+=s*5){ctx.beginPath();ctx.moveTo(x2,0);ctx.lineTo(x2,H);ctx.stroke();}for(var y2=o%(s*5);y2<H;y2+=s*5){ctx.beginPath();ctx.moveTo(0,y2);ctx.lineTo(W,y2);ctx.stroke();}}
  function drawGear(g,t){var x=g.x*W,y=g.y*H-scrollY*0.15,angle=g.angle+t*g.speed,r=g.r,teeth=g.teeth,toothH=r*0.22,toothW=(Math.PI*2/teeth)*0.38;ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.beginPath();for(var i=0;i<teeth;i++){var a0=(i/teeth)*Math.PI*2,a1=a0+toothW,a2=a0+(Math.PI*2/teeth)-toothW,a3=a0+Math.PI*2/teeth;ctx.lineTo(Math.cos(a0)*r,Math.sin(a0)*r);ctx.lineTo(Math.cos(a1)*(r+toothH),Math.sin(a1)*(r+toothH));ctx.lineTo(Math.cos(a2)*(r+toothH),Math.sin(a2)*(r+toothH));ctx.lineTo(Math.cos(a3)*r,Math.sin(a3)*r);}ctx.closePath();ctx.fillStyle=C.gear;ctx.strokeStyle=C.gearStroke;ctx.lineWidth=1.5;ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(0,0,r*0.28,0,Math.PI*2);ctx.fillStyle=C.bg;ctx.fill();ctx.strokeStyle=C.gearStroke;ctx.stroke();for(var i2=0;i2<6;i2++){var a=(i2/6)*Math.PI*2;ctx.beginPath();ctx.moveTo(Math.cos(a)*r*0.30,Math.sin(a)*r*0.30);ctx.lineTo(Math.cos(a)*r*0.75,Math.sin(a)*r*0.75);ctx.strokeStyle=C.gearStroke;ctx.lineWidth=1;ctx.stroke();}ctx.restore();}
  function drawCircuits(t){for(var ci=0;ci<CIRCUITS.length;ci++){var c=CIRCUITS[ci],alpha=0.06+0.06*Math.sin(t*c.speed+c.pulse),off=-scrollY*0.12;ctx.save();ctx.translate(0,off);ctx.strokeStyle='rgba(0,200,255,'+alpha+')';ctx.lineWidth=1;ctx.beginPath();for(var si=0;si<c.segs.length;si++){if(si===0)ctx.moveTo(c.segs[si].x,c.segs[si].y);else ctx.lineTo(c.segs[si].x,c.segs[si].y);}ctx.stroke();for(var si2=0;si2<c.segs.length;si2++){ctx.beginPath();ctx.arc(c.segs[si2].x,c.segs[si2].y,2.5,0,Math.PI*2);ctx.fillStyle='rgba(0,200,255,'+(alpha*2)+')';ctx.fill();}ctx.restore();}}

  function drawRadar(t){var off=-scrollY*0.10,cx=W*0.5,cy=H*0.5+off,R=Math.min(W,H)*0.38;ctx.save();ctx.translate(cx,cy);for(var ri=0;ri<4;ri++){var f=(ri+1)*0.25;ctx.beginPath();ctx.arc(0,0,R*f,0,Math.PI*2);ctx.strokeStyle='rgba(0,200,255,'+(0.08+0.03*f)+')';ctx.lineWidth=0.8;ctx.stroke();}var axes=[[0,1],[1,0],[0,-1],[-1,0]];for(var ai=0;ai<axes.length;ai++){ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(axes[ai][0]*R,axes[ai][1]*R);ctx.strokeStyle='rgba(0,200,255,0.07)';ctx.lineWidth=0.7;ctx.stroke();}radarAngle+=0.009;for(var a=0;a<Math.PI*0.38;a+=0.015){var angle=radarAngle-a,alpha=(1-a/(Math.PI*0.38))*0.20;ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,R,angle,angle+0.016);ctx.closePath();ctx.fillStyle='rgba(30,220,120,'+alpha+')';ctx.fill();}ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(radarAngle)*R,Math.sin(radarAngle)*R);ctx.strokeStyle='rgba(30,220,120,0.65)';ctx.lineWidth=1.5;ctx.stroke();for(var bi=0;bi<BLIPS.length;bi++){var b=BLIPS[bi],diff=((radarAngle-b.angle)%(Math.PI*2)+Math.PI*2)%(Math.PI*2);if(diff<0.06)b.life=1;else b.life=Math.max(0,b.life-b.decay);if(b.life<=0)continue;var bx=Math.cos(b.angle)*b.dist*R,by=Math.sin(b.angle)*b.dist*R,pulse=b.life*(0.5+0.5*Math.sin(t*4+b.angle));ctx.beginPath();ctx.arc(bx,by,9*b.life,0,Math.PI*2);ctx.fillStyle='rgba(30,220,120,'+(0.09*pulse)+')';ctx.fill();ctx.beginPath();ctx.arc(bx,by,3.5*b.life,0,Math.PI*2);ctx.fillStyle='rgba(30,220,120,'+(0.85*b.life)+')';ctx.fill();}ctx.restore();}

  function drawWavesAndPin(t){var off=-scrollY*0.08;for(var wi=WAVES.length-1;wi>=0;wi--){var w=WAVES[wi];w.r+=2.8;w.life-=0.004;if(w.life<=0||w.r>Math.max(W,H)*0.85){WAVES.splice(wi,1);continue;}ctx.beginPath();ctx.arc(w.x,w.y+off,w.r,0,Math.PI*2);ctx.strokeStyle='rgba(15,115,145,'+(w.life*0.22)+')';ctx.lineWidth=1+w.life;ctx.stroke();}var px=W*0.74,py=H*0.66+off,bounce=Math.sin(t*1.5)*6,pulse=0.5+0.5*Math.sin(t*1.5);ctx.save();ctx.translate(px,py+bounce);ctx.beginPath();ctx.ellipse(0,22,11,4,0,0,Math.PI*2);ctx.fillStyle='rgba(200,160,40,'+(0.10+0.05*pulse)+')';ctx.fill();ctx.beginPath();ctx.arc(0,-24,15,0,Math.PI*2);ctx.fillStyle='rgba(200,160,40,'+(0.22+0.12*pulse)+')';ctx.strokeStyle='rgba(200,160,40,'+(0.60+0.20*pulse)+')';ctx.lineWidth=1.5;ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(-9,-14);ctx.lineTo(9,-14);ctx.lineTo(0,5);ctx.closePath();ctx.fillStyle='rgba(200,160,40,'+(0.22+0.12*pulse)+')';ctx.strokeStyle='rgba(200,160,40,'+(0.60+0.20*pulse)+')';ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(0,-24,6,0,Math.PI*2);ctx.fillStyle='rgba(200,160,40,'+(0.65+0.25*pulse)+')';ctx.fill();ctx.font='bold 10px Poppins,sans-serif';ctx.fillStyle='rgba(200,160,40,0.70)';ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText('Pérez, S.Fe',0,9);ctx.restore();}

  function drawNodes(){var off=-scrollY*0.05;for(var i=0;i<NODES.length;i++){var n=NODES[i];n.x+=n.vx;n.y+=n.vy;n.tw+=n.ts;if(n.x<0||n.x>W)n.vx*=-1;if(n.y<0||n.y>H)n.vy*=-1;}for(var i2=0;i2<NODES.length;i2++){for(var j=i2+1;j<NODES.length;j++){var dx=NODES[i2].x-NODES[j].x,dy=NODES[i2].y-NODES[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<165){ctx.beginPath();ctx.moveTo(NODES[i2].x,NODES[i2].y+off);ctx.lineTo(NODES[j].x,NODES[j].y+off);ctx.strokeStyle='rgba(0,200,255,'+((1-d/165)*0.10)+')';ctx.lineWidth=0.7;ctx.stroke();}}}for(var i3=0;i3<NODES.length;i3++){var n2=NODES[i3],a=0.20+0.15*Math.sin(n2.tw);ctx.beginPath();ctx.arc(n2.x,n2.y+off,n2.r,0,Math.PI*2);ctx.fillStyle='rgba(0,200,255,'+a+')';ctx.fill();}}

  function spawnWave(){WAVES.push({x:W*0.74,y:H*0.66,r:0,life:1});}
  function spawnMsg(){var oo=[{x:W*0.04,y:H*0.28},{x:W*0.08,y:H*0.55},{x:W*0.18,y:H*0.42}];var o=oo[Math.floor(Math.random()*oo.length)];var tx=W*0.74,ty=H*0.66,dx=tx-o.x,dy=ty-o.y,dist=Math.sqrt(dx*dx+dy*dy);MSGS.push({x:o.x,y:o.y,vx:(dx/dist)*(1.8+Math.random()),vy:(dy/dist)*(1.8+Math.random()),life:1,decay:0.007,type:Math.random()>0.5?'wa':'mail',trail:[]});}
  function drawMsgs(){for(var i=MSGS.length-1;i>=0;i--){var m=MSGS[i];m.trail.push({x:m.x,y:m.y});if(m.trail.length>8)m.trail.shift();m.x+=m.vx;m.y+=m.vy;m.life-=m.decay;if(m.life<=0){MSGS.splice(i,1);continue;}var col=m.type==='wa'?'rgba(30,220,120,':'rgba(0,200,255,';for(var j=1;j<m.trail.length;j++){ctx.beginPath();ctx.moveTo(m.trail[j-1].x,m.trail[j-1].y);ctx.lineTo(m.trail[j].x,m.trail[j].y);ctx.strokeStyle=col+(j/m.trail.length*m.life*0.35)+')';ctx.lineWidth=0.9;ctx.stroke();}ctx.save();ctx.translate(m.x,m.y);ctx.globalAlpha=m.life*0.85;if(m.type==='wa'){ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fillStyle='rgba(30,220,120,0.30)';ctx.strokeStyle='rgba(30,220,120,0.90)';ctx.lineWidth=1.2;ctx.fill();ctx.stroke();ctx.font='8px sans-serif';ctx.fillStyle='rgba(30,220,120,1)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('✓✓',0,0.5);}else{ctx.beginPath();ctx.rect(-9,-6,18,12);ctx.fillStyle='rgba(0,200,255,0.18)';ctx.strokeStyle='rgba(0,200,255,0.70)';ctx.lineWidth=1;ctx.fill();ctx.stroke();}ctx.restore();}}

  function drawReticles(t){var off=-scrollY*0.18;var rr=[{x:0.18,y:0.42},{x:0.78,y:0.30},{x:0.62,y:0.82}];for(var i=0;i<rr.length;i++){var re=rr[i],rx=re.x*W,ry=re.y*H+off,pulse=0.3+0.2*Math.sin(t*0.8+re.x*10),size=18;ctx.save();ctx.globalAlpha=pulse;ctx.strokeStyle='rgba(15,200,230,0.6)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(rx-size,ry);ctx.lineTo(rx+size,ry);ctx.moveTo(rx,ry-size);ctx.lineTo(rx,ry+size);ctx.stroke();ctx.beginPath();ctx.arc(rx,ry,size*0.7,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.rect(rx-4,ry-4,8,8);ctx.stroke();ctx.restore();}}
  function drawParticles(){var off=-scrollY*0.05;for(var i=0;i<PARTICLES.length;i++){var p=PARTICLES[i];p.x+=p.vx;p.y+=p.vy;p.twinkle+=p.tSpeed;if(p.y<-10){p.y=H+10;p.x=Math.random()*W;}if(p.x<-5)p.x=W+5;if(p.x>W+5)p.x=-5;var alpha=p.alpha*(0.6+0.4*Math.sin(p.twinkle));ctx.beginPath();ctx.arc(p.x,p.y+off,p.r,0,Math.PI*2);ctx.fillStyle='rgba(15,180,210,'+alpha+')';ctx.fill();}}
  function spawnSpark(){var oo=[{x:W*0.25,y:H*0.35},{x:W*0.72,y:H*0.22},{x:W*0.55,y:H*0.68},{x:W*0.10,y:H*0.60},{x:W*0.88,y:H*0.75}];var o=oo[Math.floor(Math.random()*oo.length)];for(var i=0;i<3+Math.floor(Math.random()*5);i++){var angle=Math.random()*Math.PI*2,speed=1.5+Math.random()*3.5;SPARKS.push({x:o.x,y:o.y-scrollY*0.2,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-2,life:1,decay:0.025+Math.random()*0.04,r:1+Math.random()*2,color:C.spark[Math.floor(Math.random()*C.spark.length)],gravity:0.12,trail:[]});}}
  function drawSparks(){for(var i=SPARKS.length-1;i>=0;i--){var s=SPARKS[i];s.trail.push({x:s.x,y:s.y});if(s.trail.length>6)s.trail.shift();s.vx*=0.97;s.vy+=s.gravity;s.x+=s.vx;s.y+=s.vy;s.life-=s.decay;if(s.life<=0){SPARKS.splice(i,1);continue;}for(var j=1;j<s.trail.length;j++){ctx.beginPath();ctx.moveTo(s.trail[j-1].x,s.trail[j-1].y);ctx.lineTo(s.trail[j].x,s.trail[j].y);ctx.strokeStyle=s.color;ctx.globalAlpha=(j/s.trail.length)*s.life*0.5;ctx.lineWidth=0.8;ctx.stroke();}ctx.globalAlpha=s.life;ctx.beginPath();ctx.arc(s.x,s.y,s.r*s.life,0,Math.PI*2);ctx.fillStyle=s.color;ctx.fill();ctx.beginPath();ctx.arc(s.x,s.y,s.r*3*s.life,0,Math.PI*2);ctx.fillStyle=s.color;ctx.globalAlpha=s.life*0.15;ctx.fill();ctx.globalAlpha=1;}}

  function loop(ts){var t=ts/1000;ctx.clearRect(0,0,W,H);ctx.fillStyle=C.bg;ctx.fillRect(0,0,W,H);drawGrid();drawCircuits(t);for(var gi=0;gi<GEARS.length;gi++)drawGear(GEARS[gi],t);drawNodes();drawWavesAndPin(t);drawRadar(t);drawMsgs();drawReticles(t);drawParticles();if(ts-lastSpark>350){spawnSpark();lastSpark=ts;}drawSparks();if(ts-waveTimer>1800){spawnWave();waveTimer=ts;}if(ts-msgTimer>850){spawnMsg();msgTimer=ts;}raf=requestAnimationFrame(loop);}
  raf=requestAnimationFrame(loop);
})();
